<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Doclix — AI Document Assistant</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root{--bg:#f3f4f6;--panel:#ffffff;--accent:#0f172a;--muted:#6b7280;}
      html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
      body{background:var(--bg);display:flex;align-items:center;justify-content:center;padding:18px;}
      .app{width:100%;max-width:980px;height:88vh;background:var(--panel);border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,0.08);display:flex;overflow:hidden;}
      .sidebar{width:290px;border-right:1px solid #eef2f7;padding:18px;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg,#fff,#fbfdff);}
      .brand{display:flex;align-items:center;gap:12px}
      .logo{width:44px;height:44px;border-radius:10px;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px}
      .brand h2{margin:0;font-size:18px}
      .new-btn{margin-top:8px;padding:8px 10px;border-radius:10px;background:#0b86ff;color:#fff;border:none;cursor:pointer}
      .templates{flex:1;overflow:auto;padding-top:6px}
      .template-item{padding:10px;border-radius:8px;border:1px solid #f1f5f9;margin-bottom:8px;background:#fff;cursor:pointer}
      .main{flex:1;display:flex;flex-direction:column;}
      .topbar{padding:12px 18px;border-bottom:1px solid #eef2f7;display:flex;align-items:center;justify-content:space-between;gap:12px}
      .topbar .title{font-weight:600}
      .chat-window{flex:1;display:flex;flex-direction:column;overflow:hidden}
      .messages{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:12px;background:linear-gradient(#ffffff,#fbfdff);}
      .bubble{max-width:78%;padding:12px 14px;border-radius:14px;line-height:1.4}
      .user{align-self:flex-end;background:#0f172a;color:#fff}
      .assistant{align-self:flex-start;background:#f3f4f6;color:#111827;border:1px solid #e6e9ef}
      .composer{padding:12px 18px;border-top:1px solid #eef2f7;display:flex;gap:10px;align-items:flex-end}
      textarea{flex:1;min-height:54px;border-radius:10px;padding:10px;border:1px solid #e6e9ef;font-size:15px;resize:none}
      .send{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
      .small{font-size:13px;color:var(--muted)}
      @media(max-width:800px){
        .app{flex-direction:column;height:95vh}
        .sidebar{width:100%;display:flex;flex-direction:row;overflow:auto;padding:8px}
        .main{flex:1}
      }
    </style>
  </head>
  <body>
    <div class="app" role="application" aria-label="Doclix chat">
      <aside class="sidebar" aria-hidden="false">
        <div class="brand">
          <div class="logo">D</div>
          <div>
            <h2>Doclix</h2>
            <div class="small">AI document assistant</div>
          </div>
        </div>
        <button class="new-btn" id="newBtn">+ New Chat</button>
        <div class="templates" id="templates">
          <div class="small">Templates</div>
          <div class="template-item" data-prompt="Draft an agreement for hiring a contractor">Agreement (Contractor)</div>
          <div class="template-item" data-prompt="Write a tender application for APMC Tumsar">Tender Application</div>
          <div class="template-item" data-prompt="Create an affidavit format for document submission">Affidavit</div>
          <div class="template-item" data-prompt="Generate a simple legal notice template">Legal Notice</div>
        </div>
        <div class="small" style="padding-top:8px">Saved chats are stored locally.</div>
      </aside>

      <main class="main">
        <div class="topbar">
          <div>
            <div class="title">Doclix — Chat</div>
            <div class="small">Ask Doclix to draft or edit official documents</div>
          </div>
          <div class="small" id="status">Status: Ready</div>
        </div>

        <section class="chat-window" aria-live="polite">
          <div class="messages" id="messages" role="log" aria-relevant="additions"></div>

          <div class="composer">
            <textarea id="input" placeholder="Type: Draft a tender application for APMC Tumsar..."></textarea>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="send" id="sendBtn">Send</button>
              <button id="copyBtn" class="small" style="background:#f8fafc;border:1px solid #eef2f7;padding:8px;border-radius:8px">Copy</button>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      const messagesEl = document.getElementById('messages');
      const inputEl = document.getElementById('input');
      const sendBtn = document.getElementById('sendBtn');
      const newBtn = document.getElementById('newBtn');
      const templates = document.getElementById('templates');
      const statusEl = document.getElementById('status');

      function loadHistory(){
        try{
          const s = localStorage.getItem('doclix_chat_history_v1');
          return s? JSON.parse(s) : [{role:'assistant',content:'Hello — I am Doclix. Ask me to draft a document or choose a template.'}];
        }catch(e){ return [{role:'assistant',content:'Hello — I am Doclix. Ask me to draft a document or choose a template.'}]; }
      }

      let history = loadHistory();
      function render(){
        messagesEl.innerHTML = '';
        history.forEach(m=>{
          const div = document.createElement('div');
          div.className = 'bubble ' + (m.role==='user'?'user':'assistant');
          div.textContent = m.content;
          messagesEl.appendChild(div);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }
      render();

      async function sendMessage(){
        const text = inputEl.value.trim();
        if(!text) return;
        history.push({role:'user',content:text});
        render();
        inputEl.value = '';
        statusEl.textContent = 'Status: Sending...';
        try{
          const resp = await fetch('/api/chat', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({message:text, history})
          });
          if(!resp.ok) throw new Error('Server error');
          const data = await resp.json();
          const reply = data.reply ?? data.assistant ?? '(no reply)';
          history.push({role:'assistant',content:reply});
        }catch(err){
          console.error(err);
          history.push({role:'assistant',content:'Server error. Please check API key and try again.'});
        }finally{
          statusEl.textContent = 'Status: Ready';
          localStorage.setItem('doclix_chat_history_v1', JSON.stringify(history));
          render();
        }
      }

      sendBtn.addEventListener('click', sendMessage);
      inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

      newBtn.addEventListener('click', ()=>{
        history = [{role:'assistant',content:'Hello — I am Doclix. Ask me to draft a document or choose a template.'}];
        localStorage.removeItem('doclix_chat_history_v1');
        render();
      });

      templates.addEventListener('click', (e)=>{
        const t = e.target;
        if(t.dataset && t.dataset.prompt){
          inputEl.value = t.dataset.prompt;
          inputEl.focus();
        }
      });

      document.getElementById('copyBtn').addEventListener('click', ()=>{
        navigator.clipboard.writeText(history.map(m=>m.role+': '+m.content).join('\n\n'));
        alert('Chat copied to clipboard');
      });
    </script>
  </body>
</html>
